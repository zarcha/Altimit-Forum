var app = angular.module('AltimitForum', ['ngRoute']);

angular.module('AltimitForum')
.config(function($routeProvider){
  $routeProvider
  .when('/', {
    templateUrl: 'views/forum.html',
    controller: 'forumCtrl',
    controllerAs: 'Ctrl'
  })
  .when('/catagory/:ID', {
    templateUrl: 'views/catagory.html',
    controller: 'catagoryCtrl',
    controllerAs: 'Ctrl'
  })
  .when('/login', {
    templateUrl: 'views/login.html',
    controller: 'loginCtrl',
    controllerAs: 'Ctrl'
  })
  .otherwise({
    templateUrl: '/'
  });
});

angular.module('AltimitForum')
.controller('catagoryCtrl', ['$scope', '$http', '$routeParams', function($scope, $http, $routeParams){
  var me = this;

  me.catagory_name = "";
  me.topic;

  $http({
        method : "GET",
        url : "/api/topics/?catagory_id=" + $routeParams.ID
    }).then(function mySucces(response) {
        buildTopics(response.data);
    }, function myError(response) {
        console.log(response);
    });

  function buildTopics(responseTopic){
    if(responseTopic.length > 0 && responseTopic[0].topic_name){
      me.topic = responseTopic;
    }

    me.catagory_name = responseTopic[0].catagory_name;
  }
}]);

angular.module('AltimitForum')
.controller('forumCtrl', ['$scope', '$http', function($scope, $http){
  var me = this;

  me.forums = {};

  $http({
        method : "GET",
        url : "/api/forums"
    }).then(function mySucces(response) {
        buildForums(response.data);
    }, function myError(response) {
        console.log(response);
    });

  function buildForums(responseForum){
    var temp = {};

    responseForum.forEach(function(forum){
      if(!me.forums[forum.forum_id]){
        me.forums[forum.forum_id] = {
          forum_name: forum.forum_name,
          forum_description: forum.forum_description,
          catagories: [{
            catagory_id: forum.catagory_id,
            catagory_name: forum.catagory_name,
            catagory_description: forum.catagory_description,
            topic_count: forum.topic_count,
            topic_last_user: forum.user,
            topic_last_update: forum.topic_last_update ? new Date(forum.topic_last_update) : null
          }]
        }
      }else {
        temp = {
          catagory_id: forum.catagory_id,
          catagory_name: forum.catagory_name,
          catagory_description: forum.catagory_description,
          topic_count: forum.topic_count,
          topic_last_user: forum.user,
          topic_last_update: forum.topic_last_update ? new Date(forum.topic_last_update) : null
        };
        me.forums[forum.forum_id].catagories.push(temp);
      }
    });

    console.log(me.forums);
  };
}]);

angular.module('AltimitForum')
.controller('loginCtrl', ['$scope', '$http', function($scope, $http){
  var me = this;
  me.getUser = getUser;

  me.username = '';
  me.password = '';

  me.errorMessage = '';

  me.login = function(){
    var req = {
      method: 'POST',
      url: '/api/login',
      headers: {
        'Content-Type': undefined
      },
      params: {
        username: me.username,
        password: me.password
      }
    }

    $http(req).then(function(response){
      me.errorMessage = '';
    },
    function(response){
      me.errorMessage = 'An error occured during login. Please try again.'
      console.log('error', response);
    }).then(getUser).then(function(response){
      console.log(response);
    });
  }

  function getUser(){
    var req = {
      method: 'GET',
      url: '/api/user',
      headers: {
        'Content-Type': undefined
      }
    }

    return $http(req);
  }
}]);
