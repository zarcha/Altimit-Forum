angular.module('Services', [])
.service('authService', ['$http', '$q', '$location', function($http, $q, $location){

  var me = this;

  me.userData = null;

  me.getUser = getUser;
  me.login = login;
  me.logout = logout;

  getUser();

  function getUser(){
    var req = {
      method: 'GET',
      url: '/api/user',
      headers: {
        'Content-Type': undefined
      }
    }

    return $http(req)
    .then(function(response){
      if(response.data !== 'error'){
        me.userData = response.data;
      }
    })
    .catch(function(err){
      console.log(err);
    });
  };

  function login(username, password){
    var req = {
      method: 'POST',
      url: '/api/login',
      headers: {
        'Content-Type': undefined
      },
      params: {
        username: username,
        password: password
      }
    }

    return $http(req).then(function(response){
      me.errorMessage = '';
    },
    function(response){
      me.errorMessage = 'An error occured during login. Please try again.'
      console.log('error', response);
    });
  };

  function logout(){
    var req = {
      method: 'GET',
      url: '/api/logout',
      headers: {
        'Content-Type': undefined
      }
    }

    return $http(req)
    .then(function(response){
      if(response.data === 'success'){
        me.userData = null;
      }
    })
    .catch(function(err){
      console.log(err);
    });
  };
}]);

var app = angular.module('AltimitForum', ['ngRoute', 'Services']);

angular.module('AltimitForum')
.config(function($routeProvider){
  $routeProvider
  .when('/', {
    templateUrl: 'views/forum.html',
    controller: 'forumCtrl',
    controllerAs: 'Ctrl'
  })
  .when('/catagory/:ID', {
    templateUrl: 'views/catagory.html',
    controller: 'catagoryCtrl',
    controllerAs: 'Ctrl'
  })
  .when('/login', {
    templateUrl: 'views/login.html',
    controller: 'loginCtrl',
    controllerAs: 'Ctrl'
  })
  .when('/register', {
    templateUrl: 'views/register.html',
    controller: 'registerCtrl',
    controllerAs: 'Ctrl'
  })
  .otherwise({
    templateUrl: '/'
  });
});

angular.module('AltimitForum')
.controller('catagoryCtrl', ['$scope', '$http', '$routeParams', function($scope, $http, $routeParams){
  var me = this;

  me.catagory_name = "";
  me.catagory_description = "";
  me.topic;

  $http({
        method : "GET",
        url : "/api/topics/?catagory_id=" + $routeParams.ID
    }).then(function mySucces(response) {
        buildTopics(response.data);
    }, function myError(response) {
        console.log(response);
    });

  function buildTopics(responseTopic){
    if(responseTopic.length > 0 && responseTopic[0].topic_name){
      me.topic = responseTopic;
    }

    me.catagory_name = responseTopic[0].catagory_name;
    me.catagory_description = responseTopic[0].catagory_description;
  }
}]);

angular.module('AltimitForum')
.controller('forumCtrl', ['$scope', '$http', function($scope, $http){
  var me = this;

  me.forums = {};

  $http({
        method : "GET",
        url : "/api/forums"
    }).then(function mySucces(response) {
        buildForums(response.data);
    }, function myError(response) {
        console.log(response);
    });

  function buildForums(responseForum){
    var temp = {};

    responseForum.forEach(function(forum){
      if(!me.forums[forum.forum_id]){
        me.forums[forum.forum_id] = {
          forum_name: forum.forum_name,
          forum_description: forum.forum_description,
          catagories: [{
            catagory_id: forum.catagory_id,
            catagory_name: forum.catagory_name,
            catagory_description: forum.catagory_description,
            topic_count: forum.topic_count,
            topic_last_user: forum.user,
            topic_last_update: forum.topic_last_update ? new Date(forum.topic_last_update) : null
          }]
        }
      }else {
        temp = {
          catagory_id: forum.catagory_id,
          catagory_name: forum.catagory_name,
          catagory_description: forum.catagory_description,
          topic_count: forum.topic_count,
          topic_last_user: forum.user,
          topic_last_update: forum.topic_last_update ? new Date(forum.topic_last_update) : null
        };
        me.forums[forum.forum_id].catagories.push(temp);
      }
    });
  };
}]);

angular.module('AltimitForum')
.controller('loginCtrl', ['$scope', '$http', '$location','authService', function($scope, $http, $location, authService){
  var me = this;

  me.username = '';
  me.password = '';

  me.errorMessage = '';

  //Functions
  me.login = login;
  me.checkLogin = checkLogin;

  //Call this so that we can redirect if they are already logged in
  me.checkLogin();
  function checkLogin(){
    authService.getUser().then(function(){
      if(authService.userData){
        $location.path('/');
      }
    });
  }

  //Login through API/passport
  function login(username, password){
    var req = {
      method: 'POST',
      url: '/api/login',
      headers: {
        'Content-Type': undefined
      },
      params: {
        username: username,
        password: password
      }
    }

    $http(req).then(function(response){
      me.errorMessage = '';
      checkLogin();
    },
    function(response){
      me.errorMessage = 'An error occured during login. Please try again.'
      console.log('error', response);
    });
  }
}]);

angular.module('AltimitForum')
.controller('registerCtrl', ['$scope', '$http','$location', function($scope, $http, $location) {
  var me = this;

  me.username = '';
  me.email = '';
  me.password = '';

  me.errorMessage = '';

  me.register = register;

  function register(){
    var req = {
      method: 'POST',
      url: '/api/register',
      headers: {
        'Content-Type': undefined
      },
      params: {
        username: me.username,
        password: me.password,
        email: me.email
      }
    }

    $http(req).then(function(response){
      if(response.data === "success"){
        me.errorMessage = '';
        $location.path('/');
      }else{
        me.errorMessage = response.data;
      }

    },
    function(response){
      me.errorMessage = 'An error occured during account creation. Please try again.'
      console.log('error', response);
    });

  };
}]);

angular.module('AltimitForum')
.directive('navBar', ['authService', function(authService){
  return {
    restrict: 'E',
    scope: {},
    templateUrl: '../views/nav.html',
    link: function(scope){
      scope.authService = authService;
    }
  };
}]);
